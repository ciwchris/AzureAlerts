on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - infra/**
  pull_request:
    branches:
      - main
    paths:
      - infra/**

# https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Clinux#set-up-azure-login-with-openid-connect-authentication
permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/azure-dev-cli-apps:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: "Output"
        run: echo "C $Env:AZURE_CLIENT_ID T $Env:AZURE_TENANT_ID"
        
      - name: Log in with Azure (Federated Credentials)
        if: ${{ env.AZURE_CLIENT_ID != '' }}
        run: |
          azd login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
        shell: pwsh

      - name: Azure Dev Provision
        run: azd provision --no-prompt


